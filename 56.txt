import asyncio
import logging
import random
import json
import os
from datetime import datetime
from aiogram import Bot, Dispatcher, types
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardMarkup, InlineKeyboardButton

# –¢–æ–∫–µ–Ω –±–æ—Ç–∞
API_TOKEN = "8553279220:AAEyZBipb2FInCgCeL5__oZP_JQ08hQyDZk"

logging.basicConfig(level=logging.INFO)

bot = Bot(token=API_TOKEN)
dp = Dispatcher()

# –§–∞–π–ª—ã –∏—Å—Ç–æ—Ä–∏–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
HISTORY_FILE = "user_history.json"
SETTINGS_FILE = "user_settings.json"

# –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
user_history = {}
user_settings = {}

if os.path.exists(HISTORY_FILE):
    with open(HISTORY_FILE, "r", encoding="utf-8") as f:
        user_history = json.load(f)

if os.path.exists(SETTINGS_FILE):
    with open(SETTINGS_FILE, "r", encoding="utf-8") as f:
        user_settings = json.load(f)

def save_history():
    with open(HISTORY_FILE, "w", encoding="utf-8") as f:
        json.dump(user_history, f, ensure_ascii=False, indent=2)

def save_settings():
    with open(SETTINGS_FILE, "w", encoding="utf-8") as f:
        json.dump(user_settings, f, ensure_ascii=False, indent=2)

# Reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (Aiogram v3)
keyboard = ReplyKeyboardMarkup(
    keyboard=[
        [
            KeyboardButton(text="üöÄ –°—Ç–∞—Ä—Ç"),
            KeyboardButton(text="‚ùì –ü–æ–º–æ—â—å"),
            KeyboardButton(text="‚ÑπÔ∏è –û –±–æ—Ç–µ")
        ],
        [
            KeyboardButton(text="üí° –°–æ–≤–µ—Ç"),
            KeyboardButton(text="üìù –ò—Å—Ç–æ—Ä–∏—è")
        ],
        [
            KeyboardButton(text="üåü –¶–∏—Ç–∞—Ç–∞"),
            KeyboardButton(text="‚è∞ –ú–æ—Ç–∏–≤–∞—Ü–∏—è")
        ]
    ],
    resize_keyboard=True
)

# Inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è —Å–æ–≤–µ—Ç–æ–≤
def advice_inline_buttons(advice_list, index=0):
    inline_kb = [[InlineKeyboardButton(text=f"–°–æ–≤–µ—Ç {i+1}", callback_data=f"advice_{i}")] for i in range(len(advice_list))]
    markup = InlineKeyboardMarkup(inline_keyboard=inline_kb)
    if len(advice_list) > 1:
        prev_index = max(index - 1, 0)
        next_index = min(index + 1, len(advice_list) - 1)
        markup.inline_keyboard.append([
            InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"nav_{prev_index}"),
            InlineKeyboardButton(text="‚û°Ô∏è –î–∞–ª–µ–µ", callback_data=f"nav_{next_index}")
        ])
    markup.inline_keyboard.append([InlineKeyboardButton(text="‚ùå –ó–∞–∫—Ä—ã—Ç—å", callback_data="close")])
    return markup

# –°–æ–≤–µ—Ç—ã –∏ —Ü–∏—Ç–∞—Ç—ã
advice_list = [
    "–°–¥–µ–ª–∞–π –ø–∞—É–∑—É –∏ –ø–æ–¥—É–º–∞–π, –ø—Ä–µ–∂–¥–µ —á–µ–º –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å.",
    "–ü–æ–ø—Ä–æ–±—É–π –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ —Å–∏—Ç—É–∞—Ü–∏—é —Å –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã.",
    "–ü–æ–≥–æ–≤–æ—Ä–∏ —Å –∫–µ–º-—Ç–æ, –∫–æ–º—É –¥–æ–≤–µ—Ä—è–µ—à—å.",
    "–î–µ–ª–∞–π –º–∞–ª–µ–Ω—å–∫–∏–µ —à–∞–≥–∏, –Ω–µ —Ç–æ—Ä–æ–ø—è—Å—å.",
    "–î–æ–≤–µ—Ä—è–π —Å–µ–±–µ –∏ —Å–≤–æ–∏–º —Ä–µ—à–µ–Ω–∏—è–º."
]

quotes = [
    "–°–¥–µ–ª–∞–π —Å–µ–≥–æ–¥–Ω—è —Ç–æ, —á—Ç–æ –¥—Ä—É–≥–∏–µ –Ω–µ —Ö–æ—Ç—è—Ç, –∏ –∑–∞–≤—Ç—Ä–∞ –±—É–¥–µ—à—å –∂–∏—Ç—å —Ç–∞–∫, –∫–∞–∫ –¥—Ä—É–≥–∏–µ –Ω–µ –º–æ–≥—É—Ç.",
    "–ù–µ –±–æ–π—Å—è –∏–¥—Ç–∏ –º–µ–¥–ª–µ–Ω–Ω–æ, –±–æ–π—Å—è —Å—Ç–æ—è—Ç—å –Ω–∞ –º–µ—Å—Ç–µ.",
    "–ö–∞–∂–¥–æ–µ —É—Ç—Ä–æ ‚Äî –Ω–æ–≤—ã–π —à–∞–Ω—Å –∏–∑–º–µ–Ω–∏—Ç—å —Å–≤–æ—é –∂–∏–∑–Ω—å.",
    "–¢—Ä—É–¥–Ω–æ—Å—Ç–∏ ‚Äî —ç—Ç–æ —Å—Ç—É–ø–µ–Ω–∏ –∫ —É—Å–ø–µ—Ö—É.",
    "–¢—ã —Å–∏–ª—å–Ω–µ–µ, —á–µ–º –¥—É–º–∞–µ—à—å, –∏ —É–º–Ω–µ–µ, —á–µ–º –∫–∞–∂–µ—à—å—Å—è."
]

context_advice = {
    "—Ä–∞–±–æ—Ç–∞": ["–°–æ—Å—Ä–µ–¥–æ—Ç–æ—á—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—ã—Ö –∑–∞–¥–∞—á–∞—Ö –∏ —Ä–∞—Å—Å—Ç–∞–≤—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã.", "–û–±—Å—É–¥–∏ —Å–∏—Ç—É–∞—Ü–∏—é —Å –∫–æ–ª–ª–µ–≥–∞–º–∏."],
    "–æ—Ç–Ω–æ—à–µ–Ω–∏—è": ["–ü–æ–ø—Ä–æ–±—É–π –æ—Ç–∫—Ä—ã—Ç–æ –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å –æ —Å–≤–æ–∏—Ö —á—É–≤—Å—Ç–≤–∞—Ö.", "–ë—É–¥—å —Ç–µ—Ä–ø–µ–ª–∏–≤ –∏ —Å–ª—É—à–∞–π –¥—Ä—É–≥–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞."],
    "—É—á—ë–±–∞": ["–†–∞–∑–±–µ–π –∑–∞–¥–∞—á–∏ –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏–µ —à–∞–≥–∏.", "–ù–µ –±–æ–π—Å—è –ø—Ä–æ—Å–∏—Ç—å –ø–æ–º–æ—â–∏ —É –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π."],
    "—Ñ–∏–Ω–∞–Ω—Å—ã": ["–°–æ—Å—Ç–∞–≤—å –±—é–¥–∂–µ—Ç –∏ –ø–ª–∞–Ω–∏—Ä—É–π —Ä–∞—Å—Ö–æ–¥—ã.", "–°—Ç–∞—Ä–∞–π—Å—è –æ—Ç–∫–ª–∞–¥—ã–≤–∞—Ç—å —Ö–æ—Ç—è –±—ã –º–∞–ª–µ–Ω—å–∫—É—é —Å—É–º–º—É —Ä–µ–≥—É–ª—è—Ä–Ω–æ."]
}

user_state = {}
user_position = {}

def generate_advice(situation: str) -> list:
    situation_lower = situation.lower()
    for key in context_advice:
        if key in situation_lower:
            return random.sample(context_advice[key], k=len(context_advice[key]))
    templates = [
        f"–Ø –±—ã –ø–æ–ø—Ä–æ–±–æ–≤–∞–ª —Ç–∞–∫: {situation}. –ë—É–¥—å —É–≤–µ—Ä–µ–Ω –≤ —Å–µ–±–µ.",
        f"–ï—Å–ª–∏ —Å–∏—Ç—É–∞—Ü–∏—è —Ç–∞–∫–∞—è: {situation}, –ø–æ–ø—Ä–æ–±—É–π –º–∞–ª–µ–Ω—å–∫–∏–π —à–∞–≥ –≤–ø–µ—Ä–µ–¥.",
        f"–°–º–æ—Ç—Ä–∏ –Ω–∞ —ç—Ç–æ —Ç–∞–∫: {situation}. –ò–Ω–æ–≥–¥–∞ –ª—É—á—à–µ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –∏ –ø–æ–¥—É–º–∞—Ç—å."
    ]
    random.shuffle(templates)
    return templates

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
@dp.message()
async def handle_message(message: types.Message):
    user_id = str(message.from_user.id)
    text = message.text.lower()

    if text in ["üöÄ —Å—Ç–∞—Ä—Ç", "/start"]:
        await message.answer("–ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π AI-–†–∞–∑—Ä—É–ª—å—â–∏–∫. –ù–∞–ø–∏—à–∏ —Å–∏—Ç—É–∞—Ü–∏—é ‚Äî –∏ —è –¥–∞–º —Å–æ–≤–µ—Ç!", reply_markup=keyboard)
    elif text in ["‚ùì –ø–æ–º–æ—â—å", "/help"]:
        await message.answer(
            "–ö–æ–º–∞–Ω–¥—ã:\nüöÄ –°—Ç–∞—Ä—Ç, ‚ùì –ü–æ–º–æ—â—å, ‚ÑπÔ∏è –û –±–æ—Ç–µ\nüí° –°–æ–≤–µ—Ç, üìù –ò—Å—Ç–æ—Ä–∏—è\nüåü –¶–∏—Ç–∞—Ç–∞, ‚è∞ –ú–æ—Ç–∏–≤–∞—Ü–∏—è\n–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ —Å–∏—Ç—É–∞—Ü–∏—é, –∏ —è –¥–∞–º —Å–æ–≤–µ—Ç!",
            reply_markup=keyboard
        )
    elif text in ["‚ÑπÔ∏è –æ –±–æ—Ç–µ", "/about"]:
        await message.answer("–Ø –ø–æ–º–æ–≥–∞—é —Ä–∞–∑—Ä—É–ª–∏–≤–∞—Ç—å —Å–∏—Ç—É–∞—Ü–∏–∏, –¥–∞–≤–∞—Ç—å —Å–æ–≤–µ—Ç—ã –∏ –º–æ—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å üòé", reply_markup=keyboard)
    elif text in ["üí° —Å–æ–≤–µ—Ç", "/advice"]:
        advices = random.sample(advice_list, k=3)
        if user_id not in user_history:
            user_history[user_id] = []
        user_history[user_id].extend(advices)
        save_history()
        await message.answer("–í—ã–±–µ—Ä–∏ —Å–æ–≤–µ—Ç:", reply_markup=advice_inline_buttons(advices, 0))
    elif text in ["üìù –∏—Å—Ç–æ—Ä–∏—è", "/history"]:
        if user_id in user_history and user_history[user_id]:
            current_index = 0
            user_position[user_id] = current_index
            advice = user_history[user_id][current_index]
            await message.answer(f"–ò—Å—Ç–æ—Ä–∏—è:\n{advice}", reply_markup=advice_inline_buttons(user_history[user_id], current_index))
        else:
            await message.answer("–ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–≤–µ—Ç–æ–≤.", reply_markup=keyboard)
    elif text in ["üåü —Ü–∏—Ç–∞—Ç–∞"]:
        quote = random.choice(quotes)
        await message.answer(f"–ú–æ—Ç–∏–≤–∞—Ü–∏—è: {quote}", reply_markup=keyboard)
    elif text in ["‚è∞ –º–æ—Ç–∏–≤–∞—Ü–∏—è"]:
        user_settings[user_id] = user_settings.get(user_id, {"enabled": True, "hour": 9})
        user_settings[user_id]["enabled"] = not user_settings[user_id]["enabled"]
        save_settings()
        status = "–≤–∫–ª—é—á–µ–Ω–∞" if user_settings[user_id]["enabled"] else "–≤—ã–∫–ª—é—á–µ–Ω–∞"
        await message.answer(f"–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –º–æ—Ç–∏–≤–∞—Ü–∏—è —Ç–µ–ø–µ—Ä—å {status}.", reply_markup=keyboard)
    else:
        await message.answer("–£—Ç–æ—á–Ω–∏ —á—É—Ç—å –±–æ–ª—å—à–µ –¥–µ—Ç–∞–ª–µ–π –æ —Å–∏—Ç—É–∞—Ü–∏–∏, —á—Ç–æ–±—ã –¥–∞—Ç—å —Ç–æ—á–Ω—ã–π —Å–æ–≤–µ—Ç.", reply_markup=keyboard)
        user_state[user_id] = {"step": 1}

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ inline-–∫–Ω–æ–ø–æ–∫
@dp.callback_query()
async def handle_callback(call: types.CallbackQuery):
    data = call.data
    user_id = str(call.from_user.id)

    if data.startswith("nav_"):
        index = int(data.split("_")[1])
        if user_id in user_history and user_history[user_id]:
            advice = user_history[user_id][index]
            user_position[user_id] = index
            await call.message.edit_text(advice, reply_markup=advice_inline_buttons(user_history[user_id], index))
    elif data.startswith("advice_"):
        advice_index = int(data.split("_")[1])
        if user_id in user_history and advice_index < len(user_history[user_id]):
            chosen_advice = user_history[user_id][advice_index]
            user_position[user_id] = advice_index
            await call.message.edit_text(f"–¢—ã –≤—ã–±—Ä–∞–ª: {chosen_advice}", reply_markup=advice_inline_buttons(user_history[user_id], advice_index))
    elif data == "close":
        await call.message.edit_text("–í–æ–∑–≤—Ä–∞—Ç –∫ –æ—Å–Ω–æ–≤–Ω—ã–º –∫–Ω–æ–ø–∫–∞–º.", reply_markup=keyboard)

# –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –º–æ—Ç–∏–≤–∞—Ü–∏—è
async def daily_motivation():
    last_sent = {}
    while True:
        now = datetime.now()
        for user_id, settings in user_settings.items():
            if settings.get("enabled", True):
                send_hour = settings.get("hour", 9)
                if now.hour == send_hour and last_sent.get(user_id) != now.date():
                    quote = random.choice(quotes)
                    try:
                        await bot.send_message(user_id, f"–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –ú–æ—Ç–∏–≤–∞—Ü–∏—è: {quote}")
                        last_sent[user_id] = now.date()
                    except:
                        pass
        await asyncio.sleep(60)

# –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
async def main():
    asyncio.create_task(daily_motivation())
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())